<template>
    <div class="eon-contextmenu-wrapper eon-fg2">
        <!-- Only small devices -->
        <div class="eon-contextmenu-close eon-bg1">
            <i class="eon-contextmenu-closeIcon vicon vicon-close"></i>
        </div>
        <eon-scroll fill="false" auto-growth="true" arrowScrolls="true" thickness="6" fill="false">
            <div class="eon-contextmenu-contextmenu eon-bg1 eon-unselectable"></div>
        </eon-scroll>
    </div>
</template>

<script>
    eon.element({

        name: "eon-contextmenu",
        style: "eon-contextmenu.css",

        dependencies: [
            "../eon-overlay",
            "../eon-item",
            "../eon-scroll"
        ],

        properties: {
            /*
              @property {String} name 
              @description Contextmenu name that associates it with trigger component
            */
            name: {
                value: "",
                reflect: true
            },
            /*
             @property {Boolean} defaultStyle 
             @description Sets spacers to the content section.
             Values: true, false
             Default: true
           */
            defaultStyle: {
                value: true,
                reflect: true
            }
        },

        privateProperties: {
            /*
              @property (private) {Object} _triggerNode 
              @description Stores contextmenu trigger nodes
            */
            triggerNode: {
                value: {}
            },
            /*
              @property (private) {Object} _refs 
              @description Object with  references
            */
            refs: {
                value: {}
            },
            /*
            @property (private) {Object} _misc
            @description Object with useful information
            */
            misc: {
                value: {}
            }
        },

        privateFunctions: {
            /*
              @function (private) _createRefs
              @description Creates fast access to elements
            */
            createRefs: function () {
                var el = this;

                el._refs.placeholder = el.generatePlaceholderNode();
                el._refs.overlay = el.generateOverlayNode();
                el._refs.wrapper = el.template.querySelector(".eon-contextmenu-wrapper");
                el._refs.contextmenu = el.template.querySelector(".eon-contextmenu-contextmenu");
                el._refs.close = el.template.querySelector(".eon-contextmenu-close");
                el._refs.closeIcon = el.template.querySelector(".eon-contextmenu-closeIcon");
                el._refs.scroll = el.template.querySelector("eon-scroll");
            },
            /*
              @function (private) _setContextmenuEvent
              @description Set event to open contextmenu
            */
            setContextmenuEvent: function (triggerElement) {
                var el = this;

                if (el.dataset.version == "desktop") {
                    el._setDesktopEvents(triggerElement);

                } else {
                    el._setDeviceEvents(triggerElement);

                }
            },

            /*
            @function (private) _setupOverlay
            @description Creates the overlay and all the events for its optimal cross browser performance
            */
            setupOverlay: function () {
                var el = this;

                el._refs.overlay.classList.add("eon-contextmenu-overlay");
                el.parentNode.insertBefore(el._refs.placeholder, el);
                el._refs.overlay.appendChild(el);

                eon.registerPathListener(el);

                el.style.display = "flex";

                el._setOverlayListeners();

            },

            /*
              @function (private) {Object} _setOverlayListeners
              @description Creates the listeners of the overlay 
            */
            setOverlayListeners: function () {
                var el = this;
                var iOS = parseFloat(
                    ('' + (/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent) || [0, ''])[1])
                        .replace('undefined', '3_2').replace('_', '.').replace('_', '')
                ) || false;

                document.body.addEventListener("click", function () {
                    if (!el.isOnPath && el._misc.modal.active) {
                        el.hide();
                    }
                })

                document.body.addEventListener("contextmenu", function () {
                    if (!el.isOnPath && el._misc.modal.active) {
                        el.hide();
                    }
                }, true);

                // If the user manages the scroll we close the overlay
                window.addEventListener("scroll", function (e) {
                    if (el._misc.modal.active) {
                        el.hide();
                    }
                });

                window.addEventListener("blur", function () {
                    if (el._misc.modal.active) {
                        // el.hide();
                    }
                });

                document.body.addEventListener("touchstart", function () {
                    if (!el.isOnPath && el._misc.modal.active) {
                        el.hide();
                    }
                });

                // This behavior is only supported on iOS 10 and beyond
                if (iOS && iOS >= 10) {

                    // Prevents scrolling on mobile devices
                    window.addEventListener("touchstart", function (e) {
                        if (el._misc.modal.active && el.dataset.version == "device") {
                            if (!el.isOnPath) {
                                e.preventDefault();
                                e.stopPropagation();
                                el._misc.modal.blur = true;
                            }
                        }
                    }, { passive: false });

                    // On touch end it blurs the modal dropdown
                    window.addEventListener("touchend", function (e) {
                        if (el._misc.modal.active && el.dataset.version == "device" && el._misc.modal.blur) {
                            el._misc.modal.blur = false;
                            el.hide();
                        }
                    });

                }
            },
            /*
              @function (private) {Object} _setDesktopEvents
              @description Creates the desktop related events
              @param {Object} triggerElement
            */
            setDesktopEvents: function (triggerElement) {
                var el = this;
                var posX;
                var posY;

                triggerElement.addEventListener("contextmenu", contextmenuEvent);

                function contextmenuEvent(e) {
                    posX = e.clientX;
                    posY = e.clientY;

                    el.classList.remove("eon-boxshadow6");
                    el.classList.add("eon-boxshadow1");

                    el.show(posX, posY);

                    var exceedsObject = el._exceedsWindow();

                    (exceedsObject.exceeds == true) ? el._relocateContextmenu(posX, posY, exceedsObject) : null;
                };

            },

            /*
              @function (private) {Object} _setDeviceEvents
              @description Creates the device related events
              @param {Object} triggerElement
            */
            setDeviceEvents: function (triggerElement) {
                var el = this;

                // Long touch event functionality
                var onLongTouch;
                var timer, lockerTimer;
                var touchDuration = 800;

                el.classList.remove("eon-boxshadow1");
                el.classList.add("eon-boxshadow6");

                function touchStart(event) {
                    event.stopPropagation();
                    if (event.cancelable) {
                        event.preventDefault();
                    }
                    timer = setTimeout(onLongTouch, touchDuration);
                }

                function touchEnd() {
                    // Stops short touches from firing the event
                    if (timer) {
                        clearTimeout(timer);
                    }

                }

                onLongTouch = function () {
                    el.show();
                }

                // Events for small devices
                if (navigator.userAgent.match(/Tablet|Android|iPhone|iPad|iPod/i)) {
                    triggerElement.addEventListener("touchstart", touchStart, false);
                    triggerElement.addEventListener("touchend", touchEnd, false);

                    // Events for small resized screens
                } else {
                    triggerElement.addEventListener("pointerdown", touchStart, false);
                    triggerElement.addEventListener("pointerup", touchEnd, false);
                }

            },

            /*
              @function (private) {Object} _exceedsWindow
              @description Check if contextmenu is going to exceed window limits
            */
            exceedsWindow: function () {
                var el = this;
                var elementRect = el.getBoundingClientRect();
                var returnObject = {};

                returnObject.exceeds = false;
                returnObject.sides = {};

                if (elementRect.left < 0) {
                    returnObject.sides["left"] = true;
                    returnObject.exceeds = true;
                }

                if ((elementRect.left + elementRect.width) > window.innerWidth) {
                    returnObject.sides["right"] = true;
                    returnObject.exceeds = true;
                }

                if (elementRect.top < 0) {
                    returnObject.sides["top"] = true;
                    returnObject.exceeds = true;
                }

                if (elementRect.top + elementRect.height > window.innerHeight) {
                    returnObject.sides["bottom"] = true;
                    returnObject.exceeds = true;
                }

                return returnObject;
            },

            /* 
              @function (private) _relocateContextmenu
              @description Relocates contextmenu correctly without exceed window limits
              @param {Number} posX [Position X of mouse event click]
              @param {Number} posY [Position Y of mouse event click]
              @param {Object} exceedsObject [Side where contextmenu exceed window limits]
            */
            relocateContextmenu: function (posX, posY, exceedsObject) {
                this.style.left = (exceedsObject.sides.right) ? posX - (this.clientWidth - 1) + "px" : this.style.left;
                this.style.top = (exceedsObject.sides.bottom) ? posY - (this.clientHeight - 1) + "px" : this.style.top;
            },

            /*
             @function (private) _setupItems
             @description Sets up declarative user contextmenu items
             @param {Object} sourceNodes [Contextmenu node items]
           */
            setupItems: function (sourceNodes) {
                var el = this;
                var itemsDocFragment = document.createDocumentFragment();
                var length = sourceNodes.length;
                var item;

                while (sourceNodes.length) {
                    item = sourceNodes.shift();

                    (item.value) ? this._setupSpan(item) : null;
                    item.classList.add("eon-bg1-hoverable2");
                    (item.getAttribute("icon")) ? el._setupIcon(item) : null;

                    itemsDocFragment.appendChild(item);
                }

                // Move documentFragment to shadowRoot
                el._refs.contextmenu.appendChild(itemsDocFragment);

            },

            /*
              @function (private) _setupSpan
              @description Sets up span with name of app
              @param {Object} item [Contextmenu node icon]
           */
            setupSpan: function (item) {
                var itemSpan = document.createElement("span");

                itemSpan.innerHTML = item.value;
                itemSpan.classList.add("eon-contextmenu-itemSpan");
                item.appendChild(itemSpan)
            },

            /*
              @function (private) _setupIcon
              @description Sets up contextmenu icon
              @param {Object} item [Contextmenu node icon]
           */
            setupIcon: function (item) {
                var iconAttribute = item.icon;
                var iconPosition = item.iconPosition;
                var icon;

                if (iconAttribute.indexOf("</i>") !== -1) {
                    var tempDiv = document.createElement("div");

                    tempDiv.innerHTML = iconAttribute;
                    icon = tempDiv.querySelector("i");
                    icon.classList.add("eon-contextmenu-itemIcon");

                } else {
                    icon = document.createElement("div");
                    icon.style.backgroundImage = "url('" + iconAttribute + "')";
                    icon.classList.add("eon-contextmenu-icon");
                }

                if (iconPosition == "left") {
                    item.insertBefore(icon, item.childNodes[0]);

                } else {
                    item.appendChild(icon);
                    item.style.justifyContent = "space-between";
                }
            },

            /*
              @function (private) _verifyScreenResolution
              @description Sets device type
            */
            verifyScreenResolution: function () {
                var el = this;

                el.dataset.version = (window.innerWidth <= eon.tabletWidth) ? "device" : "desktop";

                if (el.dataset.version == "device") {
                    el.classList.add("eon-contextmenu-hide");
                }
            },

            /*
              @function (private) _verifyOpenContextmenu
              @description Checks if there is already a contextmenu open and close it
              @param {Array} openContextmenu [Stores the node of open contextmenu]
            */
            verifyOpenContextmenu: function (openContextmenu) {
                var el = this;

                if (openContextmenu.length == 1) {
                    openContextmenu[0].element.classList.remove("eon-contextmenu-wrapper-visible");
                    openContextmenu.splice(0);
                }

            },

        },

        functions: {
            /*
              @function show
              @description Shows contextmenu at position where clicked
              @param {Number} posX [Position X of mouse event click]
              @param {Number} posY [Position Y of mouse event click]
            */
            show: function (posX, posY) {
                var el = this;

                // Contextmenu opened by a click event for the responsive functionality
                if (typeof posX == "undefined" && typeof posY == "undefined") {
                    el._refs.overlay.classList.add("eon-bg1-modal");
                    el.classList.remove("eon-contextmenu-hide");
                    el.style.opacity = 1;
                    // To see the opening animation of the contextmenu
                    setTimeout(function () {
                        el.classList.add("eon-contextmenu-visible");
                    }, 0);

                    document.body.appendChild(el._refs.overlay);


                } else {
                    el.style.top = posY + "px";
                    el.style.left = posX + "px";
                    document.body.appendChild(el._refs.overlay);
                }

                el._misc.modal.active = true;

                eon.triggerCallback("onShow", this);

            },

            /*
             @function hide
             @description Hides contextmenu
            */
            hide: function () {
                var el = this;

                if (el.dataset.version == "device") {
                    el.style.opacity = 0;
                    el.classList.remove("eon-contextmenu-visible");

                    setTimeout(function () {
                        // el.classList.add("eon-contextmenu-hide");
                        el._refs.overlay.parentNode.removeChild(el._refs.overlay);
                    }, 100);

                } else {
                    el._refs.overlay.parentNode.removeChild(el._refs.overlay);
                }

                el._misc.modal.active = false;
                eon.triggerCallback("onHide", this);
            },

            /*
              @function addItem
              @description Adds new contextmenu node item programmatically
              @param {Object} item [Node to add to contextmenu]
            */
            addItem: function (item) {
                var itemSpan = item.querySelector("span");

                (item.icon) ? this._setupIcon(item) : null;
                (item.value) ? this._setupSpan(item) : null;
                item.classList.add("eon-bg1-hoverable2");

                this._refs.contextmenu.appendChild(item);
            },

            /*
              @function removeItem 
              @description Removes node item passed as parameter
              @param {Object} item [Node to removes from contextmenu] 
             */
            removeItem: function (item) {
                this._refs.contextmenu.removeChild(item);
            },

            /*
              @function replaceItem 
              @description Replaces old node item with a new one
              @param {Object} newItem [Node that replaces old one]
              @param {Object} oldItem [Node to be replaced]
             */
            replaceItem: function (newItem, oldItem) {
                var itemSpan = newItem.querySelector("span");

                (newItem.value) ? this._setupSpan(newItem) : null;
                (newItem.icon) ? this._setupIcon(newItem) : null;
                newItem.classList.add("eon-bg1-hoverable2");

                this._refs.contextmenu.replaceChild(newItem, oldItem);

            },

            /*
              @function addTrigger 
              @description Adds a new contextmenu trigger node
              @param {Object} newTrigger
             */
            addTrigger: function (newTrigger) {
                newTrigger.setAttribute("oncontextmenu", "return false");
                this._setContextmenuEvent(newTrigger);
            }
        },

        onCreated: function () {
            var el = this;

            // Create callbacks
            eon.createCallback("onShow", this);
            eon.createCallback("onHide", this);

            // Global contextmenu variables
            eon.contextmenu = eon.contextmenu || {
                openContextmenu: []
            };

            el._misc.modal = {};

            el._createRefs();
        },

        onBubbleRender: function () {
            var el = this;
            var sourceNodes = el.getSourceElements();
            var triggers = document.querySelectorAll('[eon-contextmenu=' + el.name + ']');

            el._setupOverlay();
            el._verifyScreenResolution();

            for (var i = 0; i < triggers.length; i++) {
                el.addTrigger(triggers[i]);
            }

            el._setupItems(sourceNodes);

            el._refs.scroll.onVerticalScrollCreated(function (verticalScroll) {
                eon.registerPathListener(verticalScroll);
            });

        },

        onWindowResize: function (event) {
            var el = this;

            if (el._misc.modal.active && !navigator.userAgent.match(/Tablet|Android|iPhone|iPad|iPod/i)) {
                el.hide();
                el._verifyScreenResolution();
            }
        }

    });

</script>